---
title: "Internacionalizacion"
author: "OP-TU"
date: "07/02/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introducción
El presente trabajo tiene como objetivo analizar la información disponible para la elaboración de indicadores de internacionalización, de acuerdo a lo establecido en el documento "Indicadores de Transformación Productiva (TP): definición de prioridades"[^1] 

[^1]: (ownCloud/sntpc/Observatorio Productivo/Indicadores/definicion_prioridad.doc)


# Fuente
Los archivos originales (AO) se obtienen de descargas de la página web de un proveedor de datos del sistema Lucía de la Dirección Nacional de Aduanas.

La metodología surge de:

* Trabajos previos del OP-TU: archivos de "ownCloud/sntpc/Observatorio Productivo/Contenido tecnologico""
* Documento de "Clasificación de las exportaciones uruguayas por contenido tecnológico"[^2]

[^2]: CINVE-CENIT 2014


# Listado de Indicadores 
-> Exportaciones de bienes
-> Exportaciones por contenido tecnológico
-> Coeficiente Exportador
-> Diversificación Productos
-> Diversificación Destinos

## Arquitectura
Se establece el directorio de trabajo y se cargan las librerías y las funciones:
```{r}
here::here()

library(dplyr)
library(tidyr)
library(readxl)
library(rpivotTable)
library(zoo)
library(WriteXLS)
library(reshape2)
library(stringi)
library(lubridate)
library(forcats)
library(stringr)

source('../src/FuncionesInternacionalizacion.R')
```


## Lectura bases de exportaciones y tránsitos
```{r}
exportaciones <- readRDS("~/../vburguete/Trabajos/transaction/data/internas/exportaciones.rds")
transitos <- readRDS("~/../vburguete/Trabajos/transaction/data/internas/transitos.rds")
```

## Análisis detallado exportaciones
### Resumen de la base exportaciones según año, país, aduana, mes, ncm y capítulo
```{r}
# Exportaciones en miles de dólares
export.por.anio <- exportaciones %>% export_por_anio
export.por.pais <- exportaciones %>% export_por_pais
export.por.ncm <- exportaciones %>% export_por_ncm
export.por.aduana <- exportaciones %>% export_por_aduana
export.por.mes <- exportaciones %>% export_por_mes
export.por.capitulo <- exportaciones %>% export_por_capitulo

# Estas exportaciones no contemplan ajustes.
```

```{r}
# remove(export.por.aduana, export.por.mes, export.por.capitulo)
#remove(export.por.pais, export.por.ncm)
```

## Análisis detallado tránsitos
Interesa reconocer las exportaciones que se registran en la base tránsitos. Para ello, filtramos de la base tránsitos los registros que contienen país de orígen Uruguay y país de destino distinto a Uruguay.
```{r}
transitos1 <- transitos %>% origen_URU %>% destino_NO_URU

resumen_transitos <- transitos1 %>% group_by(anio, REMITENTE) %>% summarise(CIF = sum(CIF)) %>% spread(anio, CIF) %>% group_by(REMITENTE) %>%
  mutate(`2010` = haz.cero.na(`2010`), `2011` = haz.cero.na(`2011`), `2012` = haz.cero.na(`2012`), `2013` = haz.cero.na(`2013`), 
         `2014` = haz.cero.na(`2014`), `2015` = haz.cero.na(`2015`), `2016` = haz.cero.na(`2016`), `2017` = haz.cero.na(`2017`)) %>%
  mutate(total = `2010`+`2011`+`2012`+`2013`+`2014`+`2015`+`2016`+`2017`) %>% arrange(-total)

```


#### Empresas en la base tránsitos
Interesa considerar las empresas que en al menos un año de estudio, haya registrado exportaciones mayores a U$S 500.000
```{r}
empresas_transitos <- transitos1 %>% mutate(considerar = if_else(CIF >= 500, 1, 0)) %>% group_by(anio, REMITENTE, RUC, CIF) %>% summarise(considerar = sum(considerar)) %>% filter(considerar > 0) %>%
  group_by(anio, RUC, REMITENTE) %>% summarise(CIF = sum(CIF)) %>% spread(anio, CIF) %>% 
  mutate(`2010` = haz.cero.na(`2010`), `2011` = haz.cero.na(`2011`), `2012` = haz.cero.na(`2012`), `2013` = haz.cero.na(`2013`), 
         `2014` = haz.cero.na(`2014`), `2015` = haz.cero.na(`2015`), `2016` = haz.cero.na(`2016`), `2017` = haz.cero.na(`2017`)) %>%
  mutate(total = `2010`+`2011`+`2012`+`2013`+`2014`+`2015`+`2016`+`2017`) %>% arrange(-total) 

transitos2 <- transitos1 %>% mutate(considerar = if_else(CIF >= 500, 1, 0)) %>% group_by(anio, RUC) %>% do(mutate(., si = sum(considerar))) %>% filter(si>0) %>% select(-considerar, -si)
```

PRINCIPALES EMPRESAS:
(monto superior a U$S 500.000 al menos en un año)
 [1] "PEPSI COLA MANUFACTURING CO OF" "PEPSI COLA INTERNATIONAL CORK"  "KHAIRI S.A."                    "MEGA PHARMA S.A"                "CELULOSA Y ENERGIA PUNTA PEREI" "METROVAL INTERNACIONAL S.A."   
 [7] "AIRFRAN (URUGUAY) S.A."         "UPM S.A."                       "ARES TRADING URUGUAY SA"        "HIMKEL S.A."                    "ECOLAT URUGUAY S.A."            "ATLANTICO IMPORTACION ? EXPORT"
[13] "INTRAWAY R&D SA"                "BOREMIX TRADE SA"               "MDFP S.A."                      "CUGREL COMPANY SA"              "URUGUS SA"                      "BINTECH SA"                    
[19] "SUCESORES DE MIGUEL A CASTRO"   "INSTROMET LATIN AMERICA SA"     "FERLECOM S.A."                  "GLOBAL  DAIRYNET S.A"           "ANDRITZ URUGUAY S A"            "SACEEM ZONA FRANCA S. A."      
[25] "BLANIRCO SA" 


## Ajustes
Se desea:
   1. Captar correctamente las exportaciones que se registran en la base tránsitos
   
   2. Captar correctamente las transacciones que involucran pasta/pulpa de celulosa de las plantas UPM y Montes del Plata.
      (ver tránsitos e información enviada por Uruguay XXI).
   
   3. Captar correctamente los destinos de transacciones de granos (información enviada por Uruguay XXI)
     -> Uruguay XXI, ajusta los destinos de granos para los productos con ncm_4: 1001 (Trigo), 1003 (Cebada sin procesar), 1005 (Maíz), 1107 (Malta) y 1201 (Soja).
      
   4. Depurar las exportaciones con destino Uruguay
      Las exportaciones que se hacen con destino una zona franca en el territorio uruguayo, son insumos para los procesos productivos que se desarrollan en dicha zona franca.
      Esos montos ya están considerados en la exportación del producto final. (Ej. exportación de madera a Zona Franca Nueva Palmira, como insumo para producir celulosa)

Observación: 
Las operaciones de exportación captadas en la base tránsito, son las que figuran con país de Origen: URUGUAY, Z.F.COLONIA, Z.F.FLORIDA, Z.F. FRAY BENTOS - BOTNIA, 
Z.F. LIBERTAD, Z.F. LIBERTAD (DUA), Z.F.MONTEVIDEO, Z.F.NUEVA HELVECIA, Z.F.NUEVA PALMIRA, Z.F. PARQUE DE LAS C, Z.F. PUNTA PEREIRA y Z.F.RIVERA


### Aplicar ajustes
1. Captar correctamente las exportaciones que se registran en la base tránsitos:
Son las consideradas en el objeto transitos2. Se desea incorporar a la base de exportaciones.
```{r}
# Ajustar nombres para poder unir a la base de exportaciones
transitos3 <- transitos2 %>% renombrar
```

Unir ambas bases:
```{r}
base_export <- exportaciones %>% mutate(FECHA = as.Date(FECHA)) %>% full_join(transitos3)

# Chequear que se consideren todos los datos
dim(exportaciones)[1]+dim(transitos3)[1] == dim(base_export)[1]
```


2. Captar correctamente las transacciones que involucran pasta/pulpa de celulosa de las plantas UPM y Montes del Plata.
   (ver tránsitos e información enviada por Uruguay XXI).

Para analizar las exportaciones de celulosa, se cuenta con información de las siguientes fuentes:
-> Uruguay XXI: Uruguay XXI nos envió información acerca de las exportaciones mensuales de celulosa según país de destino. También se tiene la información de las exportaciones de celulosa de la empresa UPM desagregadas mensualmente.
-> Transaction/transitos: A partir de las información de tránsitos descargada de la web de transaction, se puede extraer los tránsitos correspondientes al producto 4703 ("Pasta química de madera a la sosa (soda) o al sulfato, excepto la pasta para disolver.")

```{r}
# Fuente: Uruguay XXI -> Exportaciones de celulosa por país de destino
celulosa_uyxxi <- readRDS('../data/internas/exp.celulosa.rds')

     total_celulosa_uyxxi <- celulosa_uyxxi %>% transmute(anio = as.character(anio), ncm_4 = "4703", capitulo = "47", tot = round(total_usd / 1000, 2)) %>%
       rename(CIF = tot) %>% total_anio %>% mutate(fuente = "uyxxi")

# Fuente: transaction/transitos -> transitos celulosa desde uruguay
celulosa_transitos <- transitos3 %>% filter(ncm_4 == "4703") %>% 
  mutate(PLANTA = if_else(`ADUANA SALIDA` == "CARMELO", "Montes del Plata", "UPM")) %>% 
  rename(UM = `UNIDAD MEDIDA`, `VALOR UNIT.` = VALOR.UNIT) %>% correccion                          # correccion unidades faltantes
     
     total_celulosa_transitos <- celulosa_transitos %>% rename(CIF = FOB) %>% total_anio %>% mutate(fuente = "transitos")

um_valor <- celulosa_transitos %>% group_by(UM) %>% summarise(valor_pro = mean(`VALOR UNIT.`), valor_min = min(`VALOR UNIT.`), valor_max = max(`VALOR UNIT.`))

# Comparativo
celulosa <- union_all(total_celulosa_uyxxi, total_celulosa_transitos) %>% gather(anio, export, -fuente, -capitulo) %>% spread(fuente, export) %>%
  mutate(dif = round((uyxxi-transitos)/transitos*100, 2))

```


```{r}

# remove(total_celulosa_uyxxi, celulosa_transitos, total_celulosa_transitos, um_valor, celulosa)
# remove(empresas_transitos, transitos1, transitos2)
```

La comparación de ambas fuentes de información, da resultados distintos. 
Sabiendo que los tránsitos no reflejan las exportaciones que realmente salen del país, sino las exportaciones que ingresan a la aduana de Nueva Palmira (las "exportaciones", son almacenadas en los depósitos aduaneros hasta efectivizar su salida del país) y además que no consideran Montes del Plata.
  -> Se decide realizar los ajustes a partir de la información enviada por Uruguay XXI.

```{r}
# Depuración base enviada por Uruguay XXI
celulosa_uyxxi <- celulosa_uyxxi %>% filter(anio %in% c(2010:2017)) %>%
  transmute(anio, NCM = "4703290000", ncm_6 = NCM %>% substring(1, 6), ncm_4 = NCM %>% substring(1, 4),                   # Agrego variables básicas
            capitulo = NCM %>% substring(1, 2), pais = destino %>% toupper %>% tildes, FOB = total_usd / 1000) %>%
  mutate(`ADUANA SALIDA` = "ADUANA PASTERAS") %>% asignar_seccion_ncm  %>% correc.paises



# Se agregan las exportaciones de celulosa de Nueva Palmira, desagregadas por país de destino
base_export1 <- base_export %>% full_join(celulosa_uyxxi)

# Chequear que se consideren todos los datos
dim(celulosa_uyxxi)[1]+dim(base_export)[1] == dim(base_export1)[1]

# Ver: total de exportaciones por año según capítulo de NCM
resumen.base_export1 <- base_export1 %>% group_by(capitulo, anio) %>% summarise(tot = sum(FOB)) %>% spread(anio, tot)
```

Analizar exportaciones/tránsitos de celulosa a Argentina
```{r}
celulosa_argentina <- celulosa_uyxxi %>% filter(pais == "ARGENTINA") %>% group_by(anio) %>% summarise(total = sum(FOB)) %>% spread(anio, total) %>% 
  mutate(fuente = "UyXXI") %>% union_all(transitos %>% filter(ncm_4 == "4703" & `PAIS DESTINO` == "ARGENTINA") %>% group_by(anio) %>% 
                                           summarise(total = sum(CIF)) %>% spread(anio, total) %>% mutate(fuente = "transitos")) %>% as.data.frame %>%
  gather(anio, total, -fuente) %>% spread(fuente, total) %>% mutate(dif = round((UyXXI-transitos)/transitos*100,3))
```
-> Los montos varían, se entiende que no se está duplicando la información enviada por UYXXI. (Respuesta en espera)


```{r}
# remove(resumen.base_export1, celulosa_argentina)
```



3. Captar correctamente los destinos de transacciones de granos (información enviada por Uruguay XXI)

En el caso de las exportaciones de granos, se cuenta con información de la web de transaction, donde se tiene que parte de las exportaciones se hacen a país de destino "Z.FRANCA N. PALMIRA".
A partir de información enviada por Uruguay XXI, se desagregan estas exportaciones en los paises de destino.

```{r}
# Fuente: Uruguay XXI -> Exportaciones de granos por país de destino
granos_uyxxi <- readRDS('../data/internas/granos.rds') %>% 
  rename(pais = destino) %>% correc.paises %>% rename(destino = pais)

granos_uyxxi_2010 <- read_xlsx("../data/externas/Nueva Palmira 2010.xlsx", range = "A9:C22") %>% 
  rename(clasif = `Clasificación Uruxxi`, destino = Destino, total = `2010`) %>% 
  rename(pais = destino) %>% correc.paises %>% rename(destino = pais)
# hay que cargar el archivo ("Nueva Palmira 2010.xlsx") en databases

for (i in 2:dim(granos_uyxxi_2010)[1]) {
     granos_uyxxi_2010$clasif[i] <- if_else(is.na(granos_uyxxi_2010$clasif[i]), granos_uyxxi_2010$clasif[i-1], granos_uyxxi_2010$clasif[i]) 
   }
granos_uyxxi_2010 <- granos_uyxxi_2010 %>% mutate(anio = "2010") %>% left_join(granos_uyxxi %>% select(-anio, -total, -destino) %>% unique)

granos_uyxxi <- granos_uyxxi %>% union_all(granos_uyxxi_2010)

# remove(granos_uyxxi_2010)
```

-> Se decide sustituir las exportaciones con país de destino "Z.FRANCA N.PALMIRA", por las exportaciones reportadas por Uruguay XXI que desagregan por el destino final de las mismas.

```{r}
ncm4.granos <- c("1001", "1003", "1005", "1107", "1201")

base_export2 <- base_export1
# Veo los códigos NCM de los granos
granosNP <- base_export2 %>% filter(ncm_4 %in% ncm4.granos & pais == "Z.FRANCA N.PALMIRA")
NCMgranosNP <- granosNP %>% group_by(NCM, ncm_6, ncm_4) %>% summarise(FOB = sum(haz.cero.na(FOB))) %>% as.data.frame
# Se decide asignar a cada ncm_4, el NCM que abarca mayor monto de exportaciones
NCMgranos <- NCMgranosNP %>% group_by(ncm_4) %>% summarise(FOB = max(FOB)) %>% left_join(NCMgranosNP) %>% select(-FOB)

# Se depura la base de exportaciones de granos con país de destino "Z.FRANCA N.PALMIRA" y se agregan las exportaciones de granos desagregadas por país de destino (Fuente: Uruguay XXI)
base_export3 <- base_export2 %>% filter(!(ncm_4 %in% ncm4.granos & pais == "Z.FRANCA N.PALMIRA"))

granos_uyxxi <- granos_uyxxi %>% 
  transmute(ncm_4 = ncm4, `ADUANA SALIDA` = toupper(fuente), DESCRIPCION = descripcion.ncm4,                                # alinear variables
            pais = destino, FOB = total, anio = as.numeric(anio)) %>%
  mutate(pais = pais %>% toupper %>% tildes) %>%                                                                            # pasar a mayúsculas los países y corregir tildes
  mutate(ncm_4 =as.character(ncm_4), capitulo = substring(ncm_4, 1, 2), FOB = FOB / 1000) %>% 
  left_join(NCMgranos) %>% asignar_seccion_ncm

# Agregar las exportaciones de granos de Nueva Palmira, desagregadas por país de destino
base_export4 <- base_export3 %>% full_join(granos_uyxxi)


# Chequear que se consideren todos los datos
dim(base_export3)[1]+dim(granos_uyxxi)[1] == dim(base_export4)[1]

#remove(granos_uyxxi)
```


4. Depurar las exportaciones con destino Uruguay
```{r}
base_export5 <- base_export4 %>% export_NO_URU

# remove(base_export, base_export1, base_export2, base_export3, base_export4)
```

5.Coregir nombres de paises de destino
```{r}
df_paises <- readRDS("~/Trabajos/Internacionalizacion/data/internas/df_paises.rds")

patrones <- df_paises$pais %>% 
  append(c("\\d+", ".*GAZA.*"))
finales <- df_paises$final %>% 
  append(c("INDETERMINADO", "PALESTINA"))

pais1 <- base_export5 %>% 
  select(pais) %>% 
  arrange(pais) %>% 
  unique() %>% 
  mutate (x = pais) %>% 
  corrige_paises()

for (i in 1:length(patrones)){
  pais1 <- pais1 %>% 
    mutate(x = str_replace_all(x, patrones[[i]],  finales[[i]]))
}
  
base_export6 <- base_export5 %>% 
  left_join(pais1, by = "pais") %>% 
  select(-pais) %>% 
  rename(pais = x) %>% 
  mutate(pais = str_to_title(pais))  

# remove(espanol, ingles, frances, patrones, finales, pais1, df_paises)
```


### Resumen Exportaciones, considerando ajustes:
```{r}
base_export_final <- base_export6

#saveRDS(base_export_final, "../data/internas/base_export_final.rds")

export.por.anio.final <- base_export_final %>% group_by(anio) %>% summarise(total = sum(FOB)) %>% spread(anio, total) %>% as.data.frame
export.por.pais.final <- base_export_final %>% group_by(anio, pais) %>% summarise(total = sum(FOB)) %>% spread(anio, total) %>% arrange(-`2017`)
export.por.ncm.final <- base_export_final %>% group_by(ncm_4, anio) %>% summarise(total = sum(FOB)) %>% spread(anio, total) %>% arrange(ncm_4)
export.por.aduana.final <- base_export_final %>% group_by(`ADUANA SALIDA`, anio) %>% summarise(total = sum(FOB)) %>% spread(anio, total)
export.por.capitulo.final <- base_export_final %>% group_by(anio, capitulo) %>% summarise(total = sum(FOB)) %>% spread(anio, total) %>% arrange(-`2017`)

# remove(#export.por.anio.final, 
#        export.por.pais.final, export.por.ncm.final, export.por.capitulo.final)
```





#### Nomenclatura Común Mercosur
```{r}
NCM <- readRDS("~/../vburguete/Trabajos/Internacionalizacion/data/internas/ncm.rds") %>% mutate(codigo = as.character(codigo)) %>% 
  mutate(codigo = case_when(nchar(codigo)==3 ~ paste("0", codigo, sep = ""), TRUE ~ codigo), capitulo = substring(codigo, 1, 2))
```






# Cálculo de Indicadores
Para el cálculo de los indicadores de Internacionalización, se trabaja con la base "base_export_final" que contiene los ajustes.


## Exportaciones de bienes
```{r}
export.por.anio.final
```


## Exportaciones por contenido tecnológico
Uruguay XXI ha pasado a utilizar el concepto de "Esfuerzo Nacional Innovador". La clasificación resultante se obtiene directamente de su página web.[^3]

[^3]:http://www.uruguayxxi.gub.uy/informacion/knowledge-base/esfuerzo-nacional-innovador/

```{r}
clasif_eni <- "~/../jvillalba/pruebas/indicadores/internacionalizacion/Excel-Esfuerzo-nacional-innovador.xlsx" %>% read_xlsx %>%
  mutate(NCM6 = case_when(nchar(as.character(NCM6)) == 5 ~ paste0("0", NCM6), TRUE ~ as.character(NCM6)))

expor_clas <- base_export_final %>% transmute(anio, mes, NCM, FOB) %>% mutate(FOB = FOB/1000, ncm_6 = substring(NCM, 1, 6)) %>% rename(usd_mm = FOB) %>%
  left_join(clasif_eni, by = c("ncm_6" = "NCM6")) %>% rename(EI = "Esfuerzo Innovador", Cod_EI = "Cód EI") %>%
  mutate(EI = case_when(is.na(EI) ~ "Sin clasificar", TRUE ~ EI),
         Cod_EI = case_when(is.na(Cod_EI) ~ "SC", TRUE ~ Cod_EI))

# Para realizar la app de Shiny, es necesario agregar el país de destino a la base de expor_clas. En su lugar, agrego la clasificación de ENI a la base de exportaciones, y lo guardo en un nuevo objeto: base_export_final_eni
base_export_final_eni <- base_export_final %>% left_join(clasif_eni %>% rename(ncm_6 = NCM6, EI = "Esfuerzo Innovador", Cod_EI = "Cód EI"), by = "ncm_6") %>% 
  mutate(EI = case_when(is.na(EI) ~ "Sin clasificar", TRUE ~ EI), Cod_EI = case_when(is.na(Cod_EI) ~ "SC", TRUE ~ Cod_EI))
# Compruebo que tengo los mismos datos:
identical(expor_clas %>% group_by(anio, EI) %>% summarise(tot = sum(usd_mm)) %>% spread(anio, tot) %>% as.data.frame(),
          base_export_final_eni %>% group_by(anio, EI) %>% summarise(tot = sum(FOB/1000)) %>% spread(anio, tot) %>% as.data.frame())
# [1] TRUE

export_ncm_ei <- expor_clas %>% group_by(anio, ncm_6, Cod_EI) %>% summarise(tot = sum(usd_mm)) %>% as.data.frame # %>% spread(anio, tot)

export_ei <- export_ncm_ei %>%  group_by(anio, Cod_EI) %>% summarise(tot = sum(tot)) %>% spread(anio, tot) %>% as.data.frame 
```
-> Se observa que hay montos de exportaciones que no tienen Código de Esfuerzo Innovador asociado. 
    -> Se corrige la base granos_uyxxi, se le asigna código NCM y ncm6, considerando el que contiene mayor monto de exportación.
    -> Siguen existienedo ncm a 6 dígitos a los que no les corresponde clasificación por esfuerzo innovador, para esos códigos se les asigna "Sin Clasificar"

```{r}
#saveRDS(expor_clas, "../data/internas/shiny/expor_clas.rds")
#saveRDS(base_export_final_eni, "../data/internas/shiny/base_export_final_eni.rds")
```





## Indicadores: Coeficiente Exportador, Diversificación de Productos/Destinos

### Coeficiente Exportador
El Coeficiente Exportador, es la proporción de la producción que se exporta. Se calcula como el valor de las exportaciones sobre la producción:
         CE = (E / VBP) * 100
         
Producto Bruto Interno: El PIB a precio de comprador es la suma del valor agregado bruto de todos los productores residentes en la economía más todo impuesto a los productos, menos todo subsidio no incluido en el valor de los productos.

-> Tipo de Cambio:
```{r}
TC_anual <- readRDS('~/../vburguete/Trabajos/Varios/TC/data/internas/TC_anual.rds') %>% spread(año, tc_anual) %>% as.data.frame
TC_mensual <- readRDS('~/../vburguete/Trabajos/Varios/TC/data/internas/TC_mensual.rds')
```


-> Exportaciones (Fuente: transaction): 
Los montos de exportaciones, extraídos de la web de transaction, están expresados en miles de U$S, mientras que los montos de PIB están expresados en miles de pesos uruguayos.
Se calculan los totales en pesos considerando el tipo de cambio anual publicado por el BCU.
```{r}
export.por.anio.final.pesos <- NULL
for (i in names(export.por.anio.final)) {
    export.por.anio.final.pesos[i] <- export.por.anio.final[i] * TC_anual[i]
}
export.por.anio.final.pesos <- as.data.frame(export.por.anio.final.pesos)
names(export.por.anio.final.pesos) <- names(export.por.anio.final)
```
 

-> Exportaciones (Fuente: BCU): 
Cargo serie de exportaciones según industria (ciiu), generada en la carpeta bases_publicas (está expresada en miles de U$S):
```{r}
# file <- "../../bases_publicas/bcu/data/externas/exp_ciiu_val.xls"
# 
# datos <- function(file){                                                                           # Formato long
#   read_xls(file, range = "B8:HK44") %>%
#   rename(codigo_industria = X__1, clase_actividad = X__2, desc_industria = X__3) %>%
#   select(-clase_actividad) %>%
#   filter(!codigo_industria %in% "SECCION", is.na(codigo_industria) == FALSE) %>%
#   gather(fecha, valor, -codigo_industria, -desc_industria) %>%
#   mutate(fecha = as.Date.numeric(as.numeric(fecha), "1900-01-01 UTC"),
#          desc_industria = stri_trans_totitle(desc_industria),
#          valor_exp = as.numeric(valor),
#          anio = year(fecha), mes = month(fecha),
#          trimestre = if_else((month(fecha) >= 1 & month(fecha) <= 3), 1,
#                      if_else((month(fecha) >= 4 & month(fecha) <= 6), 2, 
#                      if_else((month(fecha) >= 7 & month(fecha) <= 9), 3, 4))),
#          codigo_industria = case_when(
#            codigo_industria %in% c("A-B-C.", "A-B-C (1)") ~ "A-B-C", 
#            codigo_industria %in% c("D.", "D (2)") ~ "D", codigo_industria == "E." ~ "E",
#            codigo_industria == "J a P (3)" ~ "J a P", TRUE ~ codigo_industria))                    # mayusculas y minusculas a titulo
# }
# exp_men_ciiu <- datos(file)                                                                        # Formato long
# 
# day(exp_men_ciiu$fecha) <- 1                                                                       # 01 de cada mes
# 
# # exp_men_ciiu_wide <- exp_men_ciiu %>% spread(fecha, valor_exp)                                   # Formato wide
```

-> Producto Interno Bruto por industrias (Fuente: BCU):
Cargo serie de PIB por código de industria (sección de ciiu), generada en la carpeta bases_publicas (está expresada en miles de $):
```{r} 
file <- "../../bases_publicas/bcu/data/externas/cuadro_100t.xls"

datos <- function(file){
  read_xls(file, range = "A10:BB22") %>%                                                           # levanta datos
  rename(codigo_industria=X__1,desc_industria=X__2) %>%
  filter(!codigo_industria %in% "De las cuales:") %>%
  melt() %>%                                                                                       # preparacion de bd incluido tratamiento de trimestre
  rename(trim_orig=variable, valor=value) %>%                                                      # mantiene dato de trimestre con formato original
  mutate(desc_industria = stri_trans_totitle(desc_industria),                                      # mayusculas y minusculas a titulo
         archivo = file, trim = trim_orig) %>%                                                     # replica trimestre original para luego modificar
  separate(trim, c("fecha", "anio"), " ") %>%                                                      # separa romano y anio
  mutate(fecha = case_when(fecha=="I" ~ "01-01", fecha=="II" ~ "01-04", 
                           fecha=="III" ~ "01-07", fecha=="IV" ~ "01-10"),
         anio = substring(anio,1,4),                                                               # limpia asterisco en anio (pero queda como character)
         fecha = dmy(paste(fecha, anio, sep="-")),                                                 # lubridate: fecha con formato d-m-y
         trimestre = quarter(fecha))                                                               # lubridate: crea trimestre con formato q.y
}

PIB <- datos(file) %>% 
  mutate(codigo_industria = 
           case_when(codigo_industria %in% c("A-B-C.", "A-B-C (1)") ~ "A-B-C",
                     codigo_industria %in% c("D.", "D (2)") ~ "D", codigo_industria == "E." ~ "E",
                     codigo_industria == "J a P (3)" ~ "J a P", 
                     desc_industria == "Servicios De Intermediación Financiera Medidos Indirectamente No Distribuidos" ~ "J",
                     TRUE ~ codigo_industria),
                     anio = year(fecha))                             # corrige clase

Imp_Sub <- PIB %>% filter(desc_industria == "Impuestos Menos Subvenciones Sobre Los Productos")

```


-> Valor Agregado (A partir de PIB publicado por BCU):
```{r}
VA <- PIB %>% filter(codigo_industria %in% c("A-B-C", "D", "E", "F", "G - H", "I", "J", "J a P"))

VA_industria <- VA %>% group_by(codigo_industria, anio) %>% summarise(valor_agregado = sum(valor))
VA_anual <- VA %>% group_by(anio) %>% summarise(valor_agregado = sum(valor))
VA_trim <- VA %>% group_by(anio, trimestre) %>% summarise(valor_agregado = sum(valor))
```


Para poder calcular el CE, es necesario unificar criterios:

- VA: los montos de producción están expresados en miles de pesos uruguayos, a valores trimestrales.
     -> periodo: I 2005 - II 2017
- exp_men_ciiu: los montos de exportaciones están expresados en miles de dólares, a valores mensuales.
     -> periodo: 01/01/2005 - 01/11/2017
  
  
Para calcular las exportaciones trimestrales en pesos uruguayos, se tiene que utilizar el tipo de cambio promedio mensual para el periodo de estudio, y luego se suman para obtener las exportaciones del trimestre.

```{r}
# exp_men_ciiu_pesos <- left_join(exp_men_ciiu, TC_mensual, by = c("anio" = "año", "mes")) %>% 
#   group_by(codigo_industria, desc_industria, anio, trimestre, mes) %>% 
#   summarise(valor_exp_pesos = sum(valor_exp * 1000 * TC_mensual))
# 
# exp_tri_ciiu_pesos <- left_join(exp_men_ciiu, TC_mensual, by = c("anio" = "año", "mes")) %>% 
#   group_by(codigo_industria, desc_industria, anio, trimestre) %>% 
#   summarise(valor_exp_pesos = sum(valor_exp * 1000 * TC_mensual))
```


-> Indicador:   CE = (E / VBP) * 100 




Fuente: BCU
```{r}
# CE_tri_bcu <- exp_tri_ciiu_pesos %>% 
#   left_join(VA, by = c("codigo_industria", "anio", "trimestre")) %>% group_by() %>% 
#   transmute(codigo_industria, desc_industria = desc_industria.x, anio, trimestre, valor_exp_pesos, valor_agregado = valor * 1000) %>%
#   filter(is.na(valor_agregado) != TRUE) %>% mutate(ce = (valor_exp_pesos / valor_agregado) * 100)
# 
# CE_industria_bcu <- CE_tri_bcu %>% group_by(codigo_industria, anio) %>% 
#   summarise(valor_exp = sum(valor_exp_pesos), valor_agregado = sum(valor_agregado), ce_ind = (valor_exp / valor_agregado) * 100)
# 
# CE_anual_bcu <- CE_tri_bcu %>% group_by(anio) %>% 
#   summarise(valor_exp = sum(valor_exp_pesos), valor_agregado = sum(valor_agregado), ce_anio = (valor_exp / valor_agregado) * 100)
```
-> Estos valores corresponden a los sectores de la industria: A, B, C, D y E


Pasar los montos de VA a miles de dólares
```{r}
VA_anual_usd_mm <- VA_anual %>% spread(anio, valor_agregado) %>% as.data.frame

for (i in names(VA_anual_usd_mm)) {
  VA_anual_usd_mm[i] <- VA_anual_usd_mm[i] / TC_anual[i]  
}

```


Fuentes: transaction (export.) y BCU (VA)
```{r}
CE_dna <- NULL
for (i in names(export.por.anio)) {
  CE_dna[i] <- export.por.anio[i] / VA_anual_usd_mm[i] * 100
}
CE_dna <- CE_dna %>% as.data.frame
names(CE_dna) <- names(export.por.anio)

CE_dna.aj <- NULL
for (i in names(export.por.anio.final)) {
  CE_dna.aj[i] <- export.por.anio.final[i] / VA_anual_usd_mm[i] * 100
}
CE_dna.aj <- CE_dna.aj %>% as.data.frame
names(CE_dna.aj) <- names(export.por.anio.final)
```
-> Estos valores corresponden a la economía en su conjunto


```{r}
ce <- left_join(
  export.por.anio.final %>% gather(anio, FOB) %>% transmute(anio, usd_mm = FOB/1000),
  VA_anual_usd_mm %>% gather(anio, va_usd_mm) %>% mutate(va_usd_mm = va_usd_mm/1000) %>% filter(anio %in% c(2010:2017))) %>%
  mutate(ce = usd_mm/va_usd_mm*100)

#saveRDS(ce, "../data/internas/shiny/coef_export_anio.rds")


# remove(PIB, Imp_Sub, VA, VA_anual, VA_industria, VA_trim)
```


-> Comparar resultados obtenidos utilizando datos de la fuente Transaction, con los datos obtenidos a partir de la base del BCU.

Para eso, se utiliza el archivo "ncm_ciiu.rds" (guardado en la carpeta bases_publicas/bcu), que relaciona los códigos del Mercosur con los códigos de actividad (ambos vinculados por el código de producto interno del Banco Central).
```{r}
# ncm_ciiu <- readRDS("../../bases_publicas/bcu/data/internas/ncm_ciiu.rds") %>% 
#   mutate(division = substring(ciiu, 1, 2), ncm_4 = substring(ncm, 1, 4)) %>% select(division, ncm, ncm_4, ciiu) %>%
#   asignar_seccion_ciiuRev3 %>% select(-division, -ciiu) %>% unique
```
-> PROBLEMA: 
      hay códigos NCM a 10 dígitos que le corresponden más de una sección.
      -> OBS.: Una vez asignada la sección según su NCM a 10 dígitos se desea asignar sección de acuerdo a su código NCM a 4 dígitos, pero para muchos casos le corresponde más de una sección.


```{r}
# base_export_final_ncm_ciiu <- base_export_final %>% select(anio, NCM, ncm_4, pais, FOB) %>% 
#     group_by(anio, NCM, ncm_4, pais) %>% summarise(FOB = sum(FOB)) %>%
#   
#   left_join(ncm_ciiu %>% filter(is.na(ncm) != TRUE) %>% transmute(NCM = ncm, seccion) %>%          # asigno sección correspondiente a su NCM a 10 dígitos
#               mutate(seccion = case_when(NCM == "1212999000" ~ "A", TRUE ~ seccion)) %>% unique) %>%
#   left_join(ncm_ciiu %>% select(-ncm) %>% group_by(ncm_4) %>% mutate(cantidad = n()) %>%           # asigno sección correspondiente a su NCM a 4 dígitos (que solo tienen una sección asociada)
#               filter(cantidad == 1), by = "ncm_4") %>%
# 
#   mutate(seccion = if_else(is.na(seccion.x) == TRUE, seccion.y, seccion.x)) %>%                    # defino sección, como la correspondiente a su NCM, en caso de no tener la correspondiente a su ncm_4
#   group_by() %>% transmute(anio, NCM, ncm_4, seccion, pais, FOB) %>% 
#   mutate(seccion = case_when(seccion %in% c("A", "B", "C") ~ "A-B-C", TRUE ~ seccion)) %>% unique  # colapso las secciones A, B y C en una única "A-B-C"
# 
# 
# ## Analizo los códigos ncm_4 que no tienen asignado seccion de ciiu:
# secciones_nulas <- base_export_final_ncm_ciiu %>% filter(is.na(seccion) == TRUE) %>% 
#   select(ncm_4) %>% unique %>% left_join(ncm_ciiu) %>% filter(is.na(seccion) == TRUE) %>% 
#   select(ncm_4) %>% arrange(ncm_4) %>% as.vector
# 
# # Corrección:
# base_export_final_ncm_ciiu <- base_export_final_ncm_ciiu %>% mutate(seccion = case_when(ncm_4 %in% secciones_nulas$ncm_4 ~ "D", TRUE ~ seccion))
# 
# sin_seccion <- length(which(is.na(base_export_final_ncm_ciiu$seccion) == TRUE))
```

-> Para los ncm a 4 dígitos "2826" "3825" "3826" "4107" "4402" y "9619", no hay sección de ciiu asignada.

-> Se decide: asignar la sección correspondiente al código anterior y/o siguiente ("2825"-"2627", "3820"..."3824", "4106" "9618"). En todos los casos, le corresponde la sección "D"

PROBLEMA: aún falta asignar secciones a 34582 casos, para los cuales su código ncm a 4 dígitos, le corresponde más de una sección.

```{r}
# remove(secciones_nulas)
```


No es posible hacer comparación con BCU, quedan muchos casos sin sección asignada.
```{r}
# base_export_final_seccion <- base_export_final_ncm_ciiu %>% group_by(anio, seccion) %>% summarise(valor_exp = sum(FOB)) %>% 
#   group_by() %>% mutate(anio = as.character(anio)) %>% left_join(TC_anual %>% gather(anio, tc), by = "anio") %>% 
#   mutate(valor_exp_pesos = valor_exp * tc) %>% select(-valor_exp, -tc)
# 
# 
# comparacion <- CE_tri_bcu %>% group_by(codigo_industria) %>% 
#   summarise(valor_exp_pesos_bcu = sum(valor_exp_pesos), valor_agregado = sum(valor_agregado)) %>%
#   full_join(export_transaction_industria, by = c("codigo_industria" = "seccion")) %>%
#   filter(is.na(valor_exp) != TRUE, is.na(valor_exp_pesos_bcu) != TRUE) %>%
#   mutate(ce_bcu = (valor_exp_pesos_bcu / valor_agregado), ce_transaction = (valor_exp / valor_agregado),
#          dif_porcentual = round(((valor_exp - valor_exp_pesos_bcu) / valor_exp) * 100, 2))


# Las diferencias en el cálculo del coeficiente exportador son del orden del 10%

```


Interesa ver en detalle, las diferencias entre las exportaciones publicadas por el bcu y las obtenidas de la web de transaction, a nivel de producto (NCM)


Exportaciones publicadas por el BCU, desagregadas por sección del producto:
```{r} 
file <- "../../bases_publicas/bcu/data/externas/exp_ncm_val.xls"                                   # Exportaciones por NCM
datos <- function(file){
  read_xls(file, range = "B8:HJ36") %>% rename(seccion = "X__1", descripcion = "X__2") %>% 
  mutate(seccion = case_when(descripcion == "OTRAS SECCIONES DE LA NCM" ~ "Otras", TRUE ~ seccion)) %>%
  filter(!seccion %in% "NCM", is.na(seccion)!=TRUE, is.na(descripcion)!=TRUE) %>% 
  corregir_seccion %>% gather(fecha, valor, -seccion, -descripcion) %>%
  mutate(fecha = as.Date.numeric(as.numeric(fecha), "1900-01-01 UTC"),
         descripcion = stri_trans_totitle(descripcion),                                            # mayusculas y minusculas a titulo
         valor_exp_bcu = as.numeric(valor),
         anio = year(fecha), mes = month(fecha),
         trimestre = if_else((month(fecha) >= 1 & month(fecha) <= 3), 1,
                     if_else((month(fecha) >= 4 & month(fecha) <= 6), 2, 
                     if_else((month(fecha) >= 7 & month(fecha) <= 9), 3, 4))))
}
exp_bcu_ncm <- datos(file)                                                                         # Formato long
exp_bcu_seccion_mes <- exp_bcu_ncm %>% group_by(seccion, descripcion, anio, trimestre, mes) %>% 
  summarise(valor_exp_bcu = sum(valor_exp_bcu))
exp_bcu_seccion_anio <- exp_bcu_ncm %>% group_by(seccion, descripcion, anio) %>% 
  summarise(valor_exp_bcu = sum(valor_exp_bcu))
```


Exportaciones de la web de transaction (se le asigna sección del producto)
```{r}
# Niveles de secciones
niveles_seccion <- paste("Sec.", as.roman(1:21))

# Las secciones: III, XII, XIV, XVIII, XX y XXI, el BCU las reporta como "Otras secciones"
seccion_otras <- c(paste("Sec.", as.roman(c(3, 12, 14, 18, 20, 21))))

# Sin ajustar
exportaciones_ncm <- exportaciones %>% asignar_seccion_ncm %>%
  transmute(seccion = case_when(seccion %in% seccion_otras ~ "Otras", TRUE ~ seccion),
            fecha = FECHA, valor_exp_tra = FOB, anio = year(fecha), mes = month(fecha), 
            trimestre = if_else((month(fecha) >= 1 & month(fecha) <= 3), 1, 
                                if_else((month(fecha) >= 4 & month(fecha) <= 6), 2, 
                                        if_else((month(fecha) >= 7 & month(fecha) <= 9), 3, 4))))
exportaciones_seccion_ncm_mes <- exportaciones_ncm %>% group_by(seccion, anio, trimestre, mes) %>% 
  summarise(valor_exp_tra = sum(valor_exp_tra))
exportaciones_seccion_ncm_anio <- exportaciones_ncm %>% group_by(seccion, anio) %>% 
  summarise(valor_exp_tra = sum(valor_exp_tra))


# Con ajustes
base_export_final_ncm <- base_export_final %>% asignar_seccion_ncm %>%
  transmute(seccion = case_when(seccion %in% seccion_otras ~ "Otras", TRUE ~ seccion),
            fecha = FECHA, valor_exp_tra = FOB, anio, mes = month(fecha), 
            trimestre = if_else((month(fecha) >= 1 & month(fecha) <= 3), 1, 
                                if_else((month(fecha) >= 4 & month(fecha) <= 6), 2, 
                                        if_else((month(fecha) >= 7 & month(fecha) <= 9), 3, 4))))
base_export_final_seccion_ncm_mes <- base_export_final_ncm %>% group_by(seccion, anio, trimestre, mes) %>% 
  summarise(valor_exp_tra = sum(valor_exp_tra))
base_export_final_seccion_ncm_anio <- base_export_final_ncm %>% group_by(seccion, anio) %>% 
  summarise(valor_exp_tra = sum(valor_exp_tra))
```


Se comparan con las exportaciones del bcu por sección del ncm
```{r}
# Comparativo sin ajustar (transaction)
comparacion_export_mensual <- full_join(
  exp_bcu_seccion_mes %>% filter(anio %in% c(2010:2017)),
  exportaciones_seccion_ncm_mes %>% mutate(valor_exp_tra = trunc(valor_exp_tra)))  %>%             # Se expresan en miles de dólares
  mutate(dif = round((valor_exp_tra - valor_exp_bcu)/valor_exp_tra * 100, 2))
comparacion_export_anual <- full_join(
  exp_bcu_seccion_anio %>% filter(anio %in% c(2010:2017)),
  exportaciones_seccion_ncm_anio %>% mutate(valor_exp_tra = trunc(valor_exp_tra))) %>% 
  mutate(dif = round((valor_exp_tra - valor_exp_bcu)/valor_exp_tra * 100, 2))

# Comparativo con ajustes (transaction)
comparacion_export_mensual_aj <- full_join(
  exp_bcu_seccion_mes %>% filter(anio %in% c(2010:2017)),
  base_export_final_seccion_ncm_mes %>% mutate(valor_exp_tra = trunc(valor_exp_tra)))  %>%         # Se expresan en miles de dólares
  mutate(dif = round((valor_exp_tra - valor_exp_bcu)/valor_exp_tra * 100, 2))
comparacion_export_anual_aj <- full_join(
  exp_bcu_seccion_anio %>% filter(anio %in% c(2010:2017)),
  base_export_final_seccion_ncm_anio %>% mutate(valor_exp_tra = trunc(valor_exp_tra))) %>% 
  mutate(dif = round((valor_exp_tra - valor_exp_bcu)/valor_exp_tra * 100, 2))

```


```{r}
# remove(niveles_seccion, seccion_otras, exportaciones_ncm, exportaciones_seccion_ncm_anio, exportaciones_seccion_ncm_mes,
#        base_export_final_ncm, base_export_final_seccion_ncm_anio, base_export_final_seccion_ncm_mes,
#        comparacion_export_anual, comparacion_export_anual_aj, comparacion_export_mensual, comparacion_export_mensual_aj)
```


## Indicadores de Diversificación

### ÍNDICE DE HERFINDAHL HIRSCHMAN

De acuerdo al documento de trabajo "Concentración de las exportaciones de Uruguay y las de sus competidores" [^4]. Se establece que un indicador para estudiar la concentración, es el Índice de Concentración de Herfindahl - Hirschmann (IHH). Este indicador tiene la propiedad de ponderar el peso de cada producto o cada país en el total de comercio, de modo que si el valor exportado es reducido, tiene una influencia pequeña en el indicador final, y viceversa. Esto se controla al tomar el cuadrado de la participación de cada país. Formalmente, el índice IHH se calcula de la siguiente manera:

IHH = (sum(x_i / x)^2) * 100       ->       0 <= IHH <= 100           IHH =   0: Perfecta diversificación - Infinitos productos/destinos
                                                                  0 < IHH <  10: No hay concentración
                                                                 10 < IHH <  18: Concentración moderada
                                                                 18 < IHH < 100: Concentración alta
                                                                      IHH = 100: Perfecta concentración - Único producto/destino

* x_i: la participación del producto/mercado i en el total de las exportaciones del país
*   x: las exportaciones totales del país

[^4]: (http://www.uruguayxxi.gub.uy/informacion/wp-content/uploads/sites/9/2015/05/Concentracion-Exportaciones-Uruguayas-y-sus-competidores-Uruguay-XXI.pdf)



Se parte de la base de exportaciones con ajustes, se calcula las exportaciones totales por ncm y las exportaciones totales por país para cada año:
```{r}
export.prod.pais <- base_export_final %>% filter(FOB != 0) %>% group_by(anio, pais, NCM, ncm_4) %>% summarise(FOB = sum(FOB)) %>% 
  group_by(anio) %>% do(mutate(., FOB_tot = sum(.$FOB))) %>%                                                                              # Export totales por año
  group_by(anio, ncm_4) %>% do(mutate(., FOB_ncm = sum(.$FOB))) %>%                                                                       # Export totales por ncm_4 y por año
  group_by(anio, pais) %>% do(mutate(., FOB_pais = sum(.$FOB)))                                                                           # Export totales por país y por año

## chequeo para la soja
test1 <- base_export_final %>% filter(ncm_4 == "1201") %>% group_by(anio) %>% summarise(FOB = round(sum(FOB),1)) %>% spread(anio, FOB) %>% as.data.frame
#      2010     2011    2012    2013    2014    2015     2016    2017
#  696658.7 850711.5 1396176 1872961 1617589 1109402 833953.1 1219654
test2 <- export.prod.pais %>% filter(ncm_4 == "1201") %>% group_by(anio) %>% summarise(FOB_ncm = round(first(FOB_ncm), 1)) %>% spread(anio, FOB_ncm) %>% as.data.frame
#      2010     2011    2012    2013    2014    2015     2016    2017
#  696658.7 850711.5 1396176 1872961 1617589 1109402 833953.1 1219654
 
identical(test1, test2)
# [1] TRUE
```
```{r}
# remove(test1, test2)
```


## Diversificación Productos

Para el caso de los productos, el Índice de Herfindahl-Hirschman pondera el peso de cada producto en el total exportado del país, haciendo que aquellos productos menos relevantes tengan poca influencia en el indicador. 

En este caso, cuando el indicador IHH toma valores cercanos a 0, significa que la diversificación es perfecta, habiendo infinitos productos y cuando toma valor igual a 100, hace referencia a un único producto.

```{r}
IHH.producto.aj <- export.prod.pais %>% group_by() %>% group_by(anio) %>% mutate(cuota2_ncm = (FOB_ncm / FOB_tot)^2)
divers.producto <- IHH.producto.aj %>% group_by(anio, ncm_4) %>% summarise(cuota2_ncm = mean(cuota2_ncm)) %>% spread(anio, cuota2_ncm) %>% as.data.frame

IHH.producto.anio <- IHH.producto.aj %>% group_by(anio) %>% summarise(IHH_ncm = sum(cuota2_ncm)) 
summary(IHH.producto.anio$IHH_ncm)


IHH.producto.anual <- IHH.producto.aj %>% group_by(anio, ncm_4) %>% summarise(cuota2_ncm = mean(cuota2_ncm)) %>% 
  group_by(anio) %>% summarise(ihh = sum(cuota2_ncm)) %>% mutate(inv_ihh = 1/ihh)
summary(IHH.producto.anual$ihh)
```
"...el Indice de Herfindahl calculado para las partidas a 4 dígitos pasa de 0,04 en 2005 a 0,06 en 2014."

Se observa que para todos los años, el IHH toma valores entre 0.040 y 0.066, por lo tanto no se puede apreciar concentración de productos. 
(no hay diferencia con el documento de referencia)

```{r}
#saveRDS(IHH.producto.aj, "../data/internas/shiny/IHH.producto.rds")
#saveRDS(divers.producto, "../data/internas/shiny/divers.producto.rds")
```


## Diversificación Destinos

Para el caso de los destinos, el Índice de Herfindahl Hirschman, pondera el peso de cada destino en el total exportado, haciendo que aquellos destinos menos relevantes tengan poca influencia en el indicador. 

Valores pequeños del indicador (menores a 10), indican muchos destinos de exportación, valores altos (mayores a 18), indican concentración de las exportaciones en pocos destinos.

```{r}
IHH.destino.aj <- export.prod.pais %>% group_by() %>% group_by(anio) %>% mutate(cuota2_pais = (FOB_pais / FOB_tot)^2)
divers.destino <- IHH.destino.aj %>% group_by(anio, pais) %>% summarise(cuota2_pais = mean(cuota2_pais)) %>% spread(anio, cuota2_pais) %>% as.data.frame

IHH.destino.anio <- IHH.destino.aj %>% group_by(anio) %>% summarise(IHH_pais = sum(cuota2_pais))

IHH.destino.anual <- IHH.destino.aj %>% group_by(anio, pais) %>% summarise(cuota2_pais = mean(cuota2_pais)) %>% 
  group_by(anio) %>% summarise(ihh = sum(cuota2_pais)) %>% mutate(inv_ihh = 1/ihh)

summary(IHH.destino.anual$ihh)
```
"En cuanto a los destinos de las exportaciones, se observa también concentración de mercados. El Indice de Herfindahl para Uruguay pasó de 0,10 en 2005 a 0,12 en 2014. Son 10 los países que concentran el 80% de las exportaciones uruguayas en 2014."

Se observa que para todos los años, el IHH toma valores entre 0.0725 y 0.1141.
(hay diferencias con el documento de referencia)


```{r}
#saveRDS(IHH.destino.aj, "../data/internas/shiny/IHH.destino.rds")
#saveRDS(divers.destino, "../data/internas/shiny/divers.destino.rds")
```

## Diversificación exportaciones
```{r}
#divers_export <- merge(IHH.productos.anio, IHH.destino.anio) %>% gather(ihh, valor, -anio) %>% spread(anio, valor)
```


##### Validación con documento de referencia: "Version final 2_con comentariosUYXXI26.07.docx" 
(ownCloud/Transforma Uruguay/Observatorio Productivo/Indicadores/Internacionalización/antecedentes)

###### Destinos

-> CHINA
```{r}
participacion_china <- IHH.destino.aj %>% filter(pais == "CHINA") %>% 
  group_by(anio, pais) %>% summarise(FOB_pais = mean(FOB_pais), cuota2_pais = mean(cuota2_pais)) %>% group_by(anio) %>% summarise(FOB_pais = sum(FOB_pais), cuota2_pais = sum(cuota2_pais)) %>%
  gather(indicadores, valor, -anio) %>% spread(anio, valor)

proporcion_china <- union_all(participacion_china, export.por.anio.final %>% mutate(indicadores = "exportaciones")) %>% gather(anio, total, -indicadores) %>% 
  spread(indicadores, total) %>% mutate(prop = FOB_pais/exportaciones*100) %>% gather(key, value, -anio) %>% spread(anio, value)

```

"El cambio más importante con respecto a los destinos de exportación es la mayor participación de China. (...) En 2014 la proporción aumentó a 24%. Esto se debe principalmente a la soja, que representa más del 50% de las exportaciones mencionadas..." 

OP:   Destino        2010       2011       2012       2013       2014       2015       2016       2017
------------------------------------------------------------------------------------------------------
        CHINA       0.007      0.017      0.030      0.047      0.050      0.054      0.050      0.080
      (monto)      626457    1155597    1576996    2164687    2252147    2075537    1838353    2620123
------------------------------------------------------------------------------------------------------
exportaciones     7676973    8870495    9180773   10013650   10084954    8892380    8260831    9251378
         prop        8.16      13.03      17.18      21.62      22.33      23.34      22.25      28.32
------------------------------------------------------------------------------------------------------
-> Hay diferencias con el doc de referencia


-> MERCOSUR
```{r}
MERCOSUR <- c("ARGENTINA", "BRASIL", "PARAGUAY", "VENEZUELA")

proporcion_mercosur <- IHH.destino.aj %>% filter(pais %in% MERCOSUR) %>%   
  select(anio, pais, FOB_tot, FOB_pais, cuota2_pais) %>% unique %>% group_by(anio) %>% 
  do(mutate(., MERCOSUR = sum(.$FOB_pais))) %>% mutate(prop = (FOB_pais / FOB_tot)*100)

# proporcion_mercosur_pais <- proporcion_mercosur %>% select(anio, pais, prop) %>% spread(anio, prop)
# proporcion_mercosur_anio <- proporcion_mercosur %>% select(anio, MERCOSUR) %>% unique %>% gather(key, value, -anio) %>% spread(anio, value)
# proporcion_mercosur_anio <- proporcion_mercosur %>% group_by(anio) %>% summarise(prop = sum(prop)) %>% unique %>% gather(key, value, -anio) %>% spread(anio, value)


participacion_mercosur <- IHH.destino.aj %>% filter(pais %in% MERCOSUR) %>% 
  group_by(anio, pais) %>% summarise(FOB_pais = mean(FOB_pais), cuota2_pais = round(mean(cuota2_pais), 3)) %>% group_by(anio, pais) %>%
  summarise(FOB_pais = sum(FOB_pais), cuota2_pais = sum(cuota2_pais)) %>%
  gather(indicadores, valor, -anio, -pais) %>% spread(anio, valor)

participacion_mercosur_cuota <- participacion_mercosur %>% filter(indicadores == "cuota2_pais")
  
```

"Si consideramos el conjunto de exportaciones al Mercosur en la década 2005-2014 la proporción se ha mantenido fluctuando entorno al 29%. Sin embargo, la composición por países del bloque ha variado. Las exportaciones a Argentina pasaron de representar el 13% en 2005 a ser el 4% en 2014. Contrariamente, las exportaciones a Brasil y Venezuela aumentaron en torno a 6 y 2 puntos porcentuales respectivamente. En cuanto a la participación de Paraguay, esta se ha mantenido constante a lo largo de la década por debajo del 2%."


OP: Destino      2010      2011       2012       2013       2014       2015       2016      2017
------------------------------------------------------------------------------------------------
  ARGENTINA      6.85      6.99       5.87       5.11       4.65       5.29       5.53      5.82
     BRASIL     19.24     19.39      16.42      18.84      18.00      14.63      15.91     14.27
   PARAGUAY      2.11      2.20       1.72       1.60       1.39       1.36       1.55      1.37
  VENEZUELA      3.23      3.78       4.54       4.51       4.12       2.30       0.62      0.23
------------------------------------------------------------------------------------------------
      TOTAL     31.44     32.36      28.56      30.06      28.17      23.58      23.60     21.68
   (montos)   2413399   2870576    2621636    3010142    2840577    2096519    1949813   2005978
------------------------------------------------------------------------------------------------
-> Para nuestro periodo de análisis, las exportaciones del Mercosur representan en promedio el 27.43% de las exportaciones del Uruguay. 
   Se mantiene el comportamiento de Paraguay y Argentina. Se destaca la caída de exportaciones a Venezuela a partir de 2015.


Concentración:

OP: Destino      2010      2011       2012       2013       2014       2015       2016      2017
------------------------------------------------------------------------------------------------
  ARGENTINA     0.005     0.005      0.003      0.003      0.002      0.003      0.003     0.003
     BRASIL     0.037     0.038      0.027      0.036      0.032      0.021      0.025     0.020
   PARAGUAY     0.000     0.000      0.000      0.000      0.000      0.000      0.000     0.000
  VENEZUELA     0.001     0.001      0.002      0.002      0.002      0.001      0.000     0.000
------------------------------------------------------------------------------------------------
      TOTAL     0.014     0.014      0.009      0.013      0.011      0.008      0.009     0.007


-> UNION EUROPEA
```{r}
UE <- c("Alemania", "Austria", "Bélgica", "Bulgaria", "Chipre", "Croacia", "Dinamarca", "España", "Eslovaquia", "Eslovenia", "Estonia", "Finlandia", "Francia", "Gran Bretaña", "Grecia", "Hungría",
        "Irlanda", "Italia", "Letonia", "Lituania", "Luxemburgo", "Malta", "Países Bajos", "Polonia", "Portugal", "República Checa", "Rumania", "Suecia") %>% toupper %>%
  union_all(c("BELGICA", "REINO UNIDO", "HOLANDA", "HOLANDA (PAISES BAJOS)", "HUNGRIA", 	"LUXEMBURGO (SOLO DUA)", "BELGICA, LUXEMBURGO", "PAISES BAJOS", "REPUBLICA CHECA"))

proporcion_ue <- IHH.destino.aj %>% filter(pais %in% UE) %>%   
  select(anio, pais, FOB_tot, FOB_pais, cuota2_pais) %>% unique %>% group_by(anio) %>% do(mutate(., UE = sum(.$FOB_pais))) %>% mutate(prop = (FOB_pais / FOB_tot)*100)

# proporcion_ue_pais <- proporcion_ue %>% select(anio, pais, prop) %>% spread(anio, prop)
# proporcion_ue_anio <- proporcion_ue %>% select(anio, UE) %>% unique %>% gather(key, value, -anio) %>% spread(anio, value)
# proporcion_ue_anio <- proporcion_ue %>% group_by(anio) %>% summarise(prop = sum(prop)) %>% unique %>% gather(key, value, -anio) %>% spread(anio, value)



participacion_ue <- IHH.destino.aj %>% filter(pais %in% UE) %>% group_by(anio, pais) %>% summarise(FOB_pais = mean(FOB_pais), cuota2_pais = mean(cuota2_pais)) %>% 
  group_by(anio) %>% summarise(FOB_pais = sum(FOB_pais), cuota2_pais = sum(cuota2_pais))
```
"El tercer socio comercial es la Unión Europea que disminuyó su participación en las exportaciones pero duplicó las mismas medidas en valor con respecto a 2005." 


OP: Destino         2010      2011      2012      2013      2014      2015      2016      2017
----------------------------------------------------------------------------------------------
UNION EUROPEA      18.90     19.00     15.73     15.39     14.68     16.49     19.06     15.52
      (monto)    1451001   1685367   1444504   1541485   1480671   1466271   1574146   1436252
         ihh      0.0060    0.0054    0.0037    0.0037    0.0031    0.0041    0.0053    0.0037
----------------------------------------------------------------------------------------------



-> ESTADOS UNIDOS
```{r}
participacion_eeuu <- IHH.destino.aj %>% filter(pais %in% c("E.E.U.U.", "ESTADOS UNIDOS")) %>% group_by(anio, pais, FOB_tot) %>% 
  summarise(FOB_pais = mean(FOB_pais), cuota2_pais = mean(cuota2_pais)) %>% group_by(anio) %>% 
  summarise(FOB_pais = sum(FOB_pais), cuota2_pais = sum(cuota2_pais), FOB_tot = mean(FOB_tot)) %>% 
  mutate(prop = (FOB_pais / FOB_tot)*100) %>% select(-FOB_tot)
```

"Otro cambio de la década a destacar es la disminución de las exportaciones a Estados Unidos. Estas pasaron de representar 18% en 2005 a 4% en 2014 y en términos monetarios cayeron casi 50%."

OP: Destino       2010       2011       2012       2013       2014       2015       2016       2017
---------------------------------------------------------------------------------------------------
      EEUU        2.56       2.75       3.67       3.84       4.49       7.05       6.04       5.74
    (monto)   196297.5   243687.8   336981.5   384435.9   453229.1   627050.7   498949.1   530797.5
       ihh      0.0007     0.0008     0.0013     0.0014     0.0018     0.0036     0.0029     0.0025
---------------------------------------------------------------------------------------------------
-> Las exportaciones a Estados Unidos se han incrementado en el periodo de análisis, pasando de representar el 2.56% de las exportaciones uruguayas de 2010 al 5.74% en 2016.


```{r}
# remove(proporcion_china, participacion_china, proporcion_ue, participacion_ue, proporcion_mercosur, participacion_mercosur, participacion_eeuu)
```


###### Productos

- Soja
```{r}
soja <- IHH.producto.aj %>% filter(ncm_4 == "1201") %>% group_by(anio, pais, ncm_4, FOB_tot, FOB_ncm, FOB_pais, cuota2_ncm) %>% summarise(FOB = sum(FOB))

  soja_anio <- soja %>% group_by(anio, FOB_tot) %>% summarise(FOB_ncm = mean(FOB_ncm), cuota2_ncm = mean(cuota2_ncm)) %>% mutate(prop = FOB_ncm / FOB_tot * 100)
  IHH.soja <- soja_anio %>% group_by(anio) %>% summarise(ihh.soja = cuota2_ncm * 100, inv.ihh.soja = 1/ihh.soja) %>% 
    gather(indice, valor, -anio) %>% mutate(valor = round(valor, 3)) %>% spread(anio, valor) %>% as.data.frame
  soja_pais <- soja %>% group_by(anio, pais, FOB_pais, FOB_tot) %>% summarise(FOB_ncm_pais = sum(FOB), cuota2_ncm_pais = (FOB_ncm_pais/FOB_pais)^2)
    
    soja_pais_anio <- soja %>% group_by(anio, pais) %>% mutate(prop = round(FOB/FOB_ncm*100, 3)) %>% group_by() %>% transmute(anio = as.character(anio), pais, prop) %>% 
      mutate(pais = case_when(pais %in% UE ~ "UE", pais %in% MERCOSUR ~ "MERCOSUR", TRUE ~ pais)) %>% 
      group_by(anio, pais) %>% summarise(prop =  sum(na.omit(prop))) %>% spread(anio, prop)
    head(soja_pais_anio %>% arrange(-`2017`))
    
    soja_china <- soja_pais_anio %>% filter(pais == "CHINA")
```
"En 2005 se produjeron unos 205 millones de toneladas mientras que al final del periodo los volúmenes eran de 308 millones, representando un incremento superior al 44%"

"Al comprar la evolución en la diversificación de los destinos de exportación, se observa que tanto los principales exportadores de soja como Uruguay mostraron una tendencia a concentrar sus ventas. Mientras que Argentina mantuvo una misma estructura (China representa casi el 90% de sus exportaciones), Estados Unidos, Brasil y Uruguay partieron de un escenario donde vendían a 4 o 5 destinos y evolucionaron a otro escenario donde concentran sus ventas a 1 o 2 destinos (con China como principal comprador)."

OP: Destino       2010      2011       2012      2013      2014      2015      2016      2017
---------------------------------------------------------------------------------------------
       CHINA     64.646   75.987     69.927    64.312    73.696    75.877    71.130    83.437
          UE     21.990   13.329     12.457    13.266     5.908    13.179    14.664     4.090
    MERCOSUR      4.324    0.867      4.271     1.150        NA        NA     7.193     2.508
       TUNEZ      4.058    4.370      1.651     3.449        NA     0.216        NA     2.444
      EGIPTO         NA       NA      3.413     9.340     8.842     3.400        NA     2.368
  BANGLADESH         NA       NA      4.351     2.170     0.838     2.902     1.301     1.303
---------------------------------------------------------------------------------------------
Obs.: Las diferencias que se ven con el cuadro de Exportaciones de soja para el año 2011, se deben a los ajustes de países de destino de exportaciones, que en el documento no fueron realizados.


OP:       IHH      2010      2011      2012      2013      2014      2015      2016      2017
---------------------------------------------------------------------------------------------
     ihh.soja     0.849     0.920     2.313     3.498     2.573     1.556     1.019     1.738
 inv.ihh.soja     1.177     1.087     0.432     0.286     0.389     0.642     0.981     0.575
---------------------------------------------------------------------------------------------
    
```{r}
# remove(soja, soja_anio, soja_pais, soja_pais_anio, soja_china)
```


- Celulosa
```{r}
celulosa <- IHH.producto.aj %>% filter(ncm_4 == "4703") %>% group_by(anio, pais, ncm_4, FOB_tot, FOB_ncm, FOB_pais, cuota2_ncm) %>% summarise(FOB = sum(FOB))

  celulosa_anio <- celulosa %>% group_by(anio, FOB_tot) %>% summarise(FOB_ncm = mean(FOB_ncm), cuota2_ncm = mean(cuota2_ncm)) %>% mutate(prop = FOB_ncm / FOB_tot *100)
  IHH.celulosa <- celulosa_anio %>% group_by(anio) %>% summarise(ihh.celulosa = cuota2_ncm*100, inv.ihh.celulosa = 1/ihh.celulosa) %>% 
    gather(indice, valor, -anio) %>% mutate(valor = round(valor,3)) %>% spread(anio, valor) %>% as.data.frame
  celulosa_pais <- celulosa %>% group_by(anio, pais, FOB_pais, FOB_tot) %>% summarise(FOB_ncm_pais = sum(FOB), cuota2_ncm_pais = (FOB_ncm_pais/FOB_pais)^2)
    
    celulosa_pais_anio <- celulosa %>% group_by(anio, pais) %>% mutate(prop = round(FOB/FOB_ncm*100, 3)) %>% group_by() %>% transmute(anio = as.character(anio), pais, prop) %>% 
      mutate(pais = case_when(pais %in% UE ~ "UE", pais %in% MERCOSUR ~ "MERCOSUR", TRUE ~ pais)) %>% 
      group_by(anio, pais) %>% summarise(prop =  sum(na.omit(prop))) %>% spread(anio, prop)
    head(celulosa_pais_anio %>% arrange(-`2017`))
```

OP:      Destino      2010      2011      2012      2013      2014      2015      2016      2017
------------------------------------------------------------------------------------------------
           CHINA    35.402    33.522    44.659    44.967    39.898    35.313    38.645    43.034
              UE    64.070    65.636    52.864    46.329    42.781    40.587    46.711    38.955
        MERCOSUR     0.527     0.842     1.661     1.901     7.370     8.550     3.315     6.656
  ESTADOS UNIDOS        NA     0.000        NA     0.000     3.110     7.968     4.800     5.385
         TURQUIA        NA     0.000        NA        NA     0.534     2.163     3.801     1.871
   COREA DEL SUR        NA        NA     0.816     3.160     2.693     1.608     1.337     1.628
------------------------------------------------------------------------------------------------
-> No es posible hacer comparación con el documento, utilizan desagregado por tipo de fibra de celulosa (fibra corta / larga)


OP:          IHH      2010      2011      2012      2013      2014      2015      2016      2017
------------------------------------------------------------------------------------------------
    ihh.celulosa     0.877     0.495     0.400     0.472     0.781     1.985     2.404     2.298
inv.ihh.celulosa     1.141     2.018     2.502     2.120     1.281     0.504     0.416     0.435
------------------------------------------------------------------------------------------------
 

```{r}
# remove(celulosa, celulosa_anio, celulosa_pais, IHH.celulosa, celulosa_pais_anio)
```

- Arroz
```{r}
arroz <- IHH.producto.aj %>% filter(ncm_4 == "1006") %>% group_by(anio, pais, ncm_4, FOB_tot, FOB_ncm, FOB_pais, cuota2_ncm) %>% summarise(FOB = sum(FOB))

  arroz_anio <- arroz %>% group_by(anio, FOB_tot) %>% summarise(FOB_ncm = mean(FOB_ncm), cuota2_ncm = mean(cuota2_ncm)) %>% mutate(prop = FOB_ncm / FOB_tot *100) 
  IHH.arroz <- arroz_anio %>% group_by(anio) %>% summarise(ihh.arroz = cuota2_ncm*100, inv.ihh.arroz = 1/ihh.arroz) %>% 
    gather(indice, valor, -anio) %>% mutate(valor = round(valor,3)) %>% spread(anio, valor) %>% as.data.frame
  arroz_pais <- arroz %>% group_by(anio, pais, FOB_pais, FOB_tot) %>% summarise(FOB_ncm_pais = sum(FOB), cuota2_ncm_pais = (FOB_ncm_pais/FOB_pais)^2)
    
    arroz_pais_anio <- arroz %>% group_by(anio, pais) %>% mutate(prop = round(FOB/FOB_ncm*100, 3)) %>% group_by() %>% 
      transmute(anio = as.character(anio), pais, prop = round(prop,2)) %>% spread(anio, prop)
    head(arroz_pais_anio %>% as.data.frame %>% arrange(-`2014`), 10)

```
"En cuanto a los mercados de exportación, existió un proceso de diversificación. En 2005 Uruguay vendía arroz a 25 países y 4 de ellos concentraban el 90% de las exportaciones mientras que en 2014 el número de compradores aumentó a 43 y son 9 los países que concentran el 90%..."


OP:   Destino      2010      2011      2012      2013      2014      2015      2016      2017
---------------------------------------------------------------------------------------------
         IRAK      6.80     15.48     23.57     21.33     40.38     22.04      6.06      9.87
         PERU     13.42     19.20     22.89     18.16     17.79     25.64     24.33     25.85
       BRASIL     47.54     15.18     14.54     17.29     11.95      5.41     24.32     19.26
       MEXICO      0.15      4.44      4.59      5.63      5.84     11.51      7.33     12.72
 SIERRA LEONA      0.28      0.76      0.32      3.50      3.76      6.77      3.29      4.58
   COSTA RICA      0.20      0.44      0.44      1.43      2.22      2.47      3.52      2.94
      BELGICA      1.69      3.43      2.79      2.29      2.09      2.42      2.96      2.73
  REINO UNIDO      1.32      1.84      2.70      1.47      2.06      1.20      1.15      1.28
    VENEZUELA        NA        NA      6.69      6.66      1.86      8.20      4.84      2.65
        BENIN        NA      0.22      0.32        NA      1.54      0.22        NA        NA
---------------------------------------------------------------------------------------------
En nuestro caso, tenemos que el 90% de las exportaciones de arroz en el año 2014 se realizan a 10 países.


"...Lo mismo puede verse mediante el índice de Herfindahl invertido. Éste arroja una medida aproximada de la cantidad de mercados relevantes o que concentran una proporción importante del arroz exportado, y pasó de tomar el valor 3,7 en 2005 a 5,2 en 2014."

OP:       IHH      2011      2012      2013      2014      2015      2016
-------------------------------------------------------------------------
    ihh.arroz     0.303     0.287     0.258     0.250     0.162     0.271
inv.ihh.arroz     3.306     3.479     3.875     4.007     6.173     3.685
-------------------------------------------------------------------------
En nuestro caso, en 2014 el inverso del Índice de Herfindahl, toma el valor igual a 4.


```{r}
# remove(arroz, arroz_anio, IHH.arroz, arroz_pais, arroz_pais_anio)
```


- Trigo
```{r}
trigo <- IHH.producto.aj %>% filter(ncm_4 == "1001") %>% group_by(anio, pais, ncm_4, FOB_tot, FOB_ncm, FOB_pais, cuota2_ncm) %>% summarise(FOB = sum(FOB))

  trigo_anio <- trigo %>% group_by(anio, FOB_tot) %>% summarise(FOB_ncm = mean(FOB_ncm), cuota2_ncm = mean(cuota2_ncm)) %>% mutate(prop = FOB_ncm / FOB_tot *100) 
  IHH.trigo <- trigo_anio %>% group_by(anio) %>% summarise(ihh.trigo = cuota2_ncm*100, inv.ihh.trigo = 1/ihh.trigo) %>% 
    gather(indice, valor, -anio) %>% mutate(valor = round(valor,3)) %>% spread(anio, valor) %>% as.data.frame
  trigo_pais <- trigo %>% group_by(anio, pais, FOB_pais, FOB_tot) %>% summarise(FOB_ncm_pais = sum(FOB), cuota2_ncm_pais = (FOB_ncm_pais/FOB_pais)^2)
    
    trigo_pais_anio <- trigo %>% group_by(anio, pais) %>% mutate(prop = round(FOB/FOB_ncm*100, 3)) %>% group_by() %>% transmute(anio = as.character(anio), pais, prop) %>% spread(anio, prop) %>%
      group_by(pais, `2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`) %>% summarise(media = round(mean(na.omit(c(`2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`))),2))
    head(trigo_pais_anio %>% arrange(-media))

    
resumen_trigo <- base_export_final %>% filter(ncm_4 == "1001")  %>% group_by(anio) %>% summarise(TON.BRUTAS = sum(na.omit(KG.BRUTOS/1000)), FOB = sum(na.omit(FOB))) %>% 
  gather(cantidad, valor, -anio) %>% spread(anio, valor)
resumen_trigo_montos <- base_export_final %>% filter(ncm_4 == "1001")  %>% group_by(anio, `UNIDAD MEDIDA`) %>% summarise(VALOR.UNIT. = round(mean(na.omit(VALOR.UNIT.)),2)) %>% 
  filter(`UNIDAD MEDIDA` %in% c("KILOGRAMO", "TONELADAS")) %>% spread(anio, VALOR.UNIT.)
```

"En promedio, Uruguay exportó 51 mil toneladas de trigo duro al año, contra 736 mil toneladas de trigo blando. En 2010, 2012 y 2014 se registraron picos en la evolución exportadora, superando el millón de toneladas exportadas. Mientras los primeros años del período mostraron los peores desempeños con menos de 200 mil toneladas al año. La significativa caída del año 2013 fue consecuencia de serios problemas en la oferta nacional originados por la mala cosecha obtenida a fines de 2012."

OP:                    2010       2011       2012      2013      2014      2015       2016      2017
----------------------------------------------------------------------------------------------------
             FOB   344342.9   311054.3   412644.3  300289.0  301763.7  121284.5  104105.2   38679.72
      TON.BRUTAS   697983.2   706380.2  1095381.3  726415.0  810416.8  389197.0  420905.3  189305.45
----------------------------------------------------------------------------------------------------
Con los datos disponibles, se puede apreciar además que las exportaciones de soja tuvieron una fuerte caída en 2015, disminuyendo 52% las cantidades exportadas. En el 2016, estas cantidades aumentaron 8% pero se redujeron los montos, lo que evidencia una caída en los precios. Que la vemos a continuación:


OP: UNIDAD MEDIDA       2010       2011       2012      2013      2014      2015       2016      2017
-----------------------------------------------------------------------------------------------------
        KILOGRAMO       0.23      32.64       0.21      0.32      0.28      0.38       0.28        NA
        TONELADAS     208.77     260.98     254.50    291.28   1056.84    205.16     193.38    171.23
-----------------------------------------------------------------------------------------------------

"Los destinos de las exportaciones se mantuvieron concentrados. Casi el 60% de las exportaciones de trigo blando se realizaron a través Zonas Francas (ZF). Los datos espejo muestran a Brasil en un despegado primer lugar como destino del 70% de las exportaciones del período, seguido de los países africanos Marruecos, Argelia, Sudáfrica y Nigeria, que juntos representan el 19% del volumen exportado para los 10 años analizados." 


OP:   Destino       2010       2011       2012      2013      2014      2015       2016      2017   media
---------------------------------------------------------------------------------------------------------
       BRASIL     81.944     53.431     40.305    71.964    75.530    73.838     84.463    13.445   61.86
      ARGELIA      1.011     14.108      9.671        NA     1.165     2.677      0.319    63.486   13.21
    MARRUECOS         NA     10.234     25.278     4.438     2.852     3.913      4.634        NA    8.56
      FRANCIA         NA         NA         NA        NA        NA        NA         NA     8.356    8.36
    TAILANDIA         NA         NA         NA        NA     1.798     8.619         NA        NA    5.21
        CHILE         NA         NA      1.644        NA        NA        NA      6.931        NA    4.29
      HOLANDA         NA         NA         NA     0.893     0.081        NA         NA    10.628    3.87
     PARAGUAY         NA         NA         NA     7.199     0.513        NA         NA        NA    3.86
        TUNEZ         NA         NA      3.649        NA        NA        NA         NA        NA    3.65
   MAURITANIA         NA      5.696      3.365        NA     1.088        NA         NA     4.086    3.56
---------------------------------------------------------------------------------------------------------
En nuestro caso, que analizamos otro periodo de tiempo, vemos que los principales países a donde se destinan las exportaciones de trigo coinciden. Siendo Brasil, el principal destino con el 66%, Marruecos en segundo lugar con 8.5% y Argelia en tercer lugar con 5.5%. A partir del cuarto lugar, los países varían con relación al documento de referencia.

"El Inverso de Herfindahl Hirschman arroja un promedio para el período 2005-2015 igual a 2."


OP:       IHH      2010       2011       2012      2013      2014      2015       2016      2017
------------------------------------------------------------------------------------------------
    ihh.trigo     0.202      0.123      0.202      0.09     0.090     0.019      0.016     0.002
inv.ihh.trigo     4.944      8.132      4.950     11.12    11.169    53.756     62.965   572.066
------------------------------------------------------------------------------------------------
-> Diferencia (ver)


```{r}
# remove(trigo, trigo_pais_anio, trigo_anio, IHH.trigo, trigo_pais, resumen_trigo, resumen_trigo_montos)
```


- Carne Bovina
```{r}
# Vuelvo a armar la base, según código NCM a 6 dígitos:
export.prod.pais.ncm6 <- base_export_final %>% filter(FOB != 0) %>% mutate(ncm_6 = substring(NCM, 1, 6)) %>% 
  group_by(anio, pais, NCM, ncm_6) %>% summarise(FOB = sum(FOB)) %>% 
  group_by(anio) %>% do(mutate(., FOB_tot = sum(.$FOB))) %>%                                                                              # Export totales por año
  group_by(anio, ncm_6) %>% do(mutate(., FOB_ncm = sum(.$FOB))) %>%                                                                       # Export totales por ncm_6 y por año
  group_by(anio, pais) %>% do(mutate(., FOB_pais = sum(.$FOB)))                                                                           # Export totales por país y por año


carne_pais <- base_export_final %>% filter(FOB != 0) %>% mutate(ncm_6 = substring(NCM, 1, 6)) %>% 
  filter(ncm_6 %in% c("020130", "020220", "020230")) %>% mutate(pais = case_when(pais %in% UE ~ "UE", TRUE ~ pais)) %>% 
  group_by(anio, pais, capitulo) %>% summarise(FOB = sum(FOB)) %>% group_by(anio, capitulo) %>% do(mutate(., FOB_capitulo = sum(.$FOB))) %>%
  group_by(anio, pais) %>% mutate(prop = round(FOB/FOB_capitulo *100,3)) %>% group_by() %>% transmute(anio, pais, prop) %>% spread(anio, prop) %>%
  group_by(pais, `2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`) %>% summarise(media = mean(na.omit(c(`2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`)))) %>%
  arrange(-`media`) %>% as.data.frame
head(carne_pais, 10)

# bases auxiliares
carne <- export.prod.pais.ncm6 %>% filter(ncm_6 %in% c("020130", "020220", "020230")) %>% mutate(capitulo = substring(ncm_6, 1, 2)) %>% 
  group_by(anio, pais, capitulo, ncm_6, FOB_tot, FOB_ncm, FOB_pais) %>% summarise(FOB = sum(FOB)) %>% mutate(cuota2_ncm = (FOB_ncm / FOB_tot)^2)
total_carne_anio <- carne %>% group_by() %>% select(anio, ncm_6, FOB_ncm) %>% unique %>% spread(ncm_6, FOB_ncm) %>% mutate(total = haz.cero.na(`020130`)+haz.cero.na(`020220`)+haz.cero.na(`020230`))
carne <- carne %>% left_join(total_carne_anio %>% select(anio, total))

carne_anio <- carne %>% group_by(anio, FOB_tot) %>% summarise(FOB_ncm = mean(FOB_ncm), cuota2_ncm = mean(cuota2_ncm)) %>% mutate(prop = FOB_ncm / FOB_tot *100) 
  IHH.carne <- carne_anio %>% group_by(anio) %>% summarise(ihh.carne = cuota2_ncm*100, inv.ihh.carne = 1/ihh.carne) %>% 
    gather(indice, valor, -anio) %>% mutate(valor = round(valor,3)) %>% spread(anio, valor) %>% as.data.frame
  
resumen_carne_ncm6 <- carne %>% group_by(ncm_6, anio) %>% summarise(FOB = sum(FOB)) %>% group_by(anio) %>% do(mutate(., FOB_tot = sum(.$FOB))) %>% mutate(prop = FOB/FOB_tot*100) %>% 
  gather(cantidad, valor, -ncm_6, -anio) %>% mutate(variable = paste(cantidad, ncm_6)) %>% select(-ncm_6, -cantidad) %>% spread(variable, valor) %>% 
  rename(FOB_tot =  `FOB_tot 020130`) %>% select(- `FOB_tot 020220`, - `FOB_tot 020230`)

```
 
"Para la carne deshuesada refrigerada se destaca la presencia de Suiza y Brasil en la lista de los 10 mercados importadores más importantes, mientras que el resto de los países ya son principales importadores de carne bovina en general. Algo similar ocurre con la carne deshuesada congelada (20230) aunque en este caso el peso relativo de los países difiere de los observados para el producto a nivel general. Finalmente para la carne sin deshuesar en trozos congelada (20220) tanto la distribución como el peso relativo difiere considerablemente del patrón observado para la carne bovina en general probablemente reflejando distintos hábitos y gustos de los consumidores."


"Uruguay exporta tres partidas correspondientes al rubro carne bovina; 020130 (carne deshuesada enfriada), 020220 (carne con hueso congelada) y 020230 (carne deshuesada congelada). Las carnes deshuesadas concentran los valores exportados (25% las enfriadas y 73% las congeladas) mientras que las con hueso representan solo el 2% de los valores exportados  entre 2005 y 2014. En términos de valores absolutos las exportaciones totales de estas partidas ascienden a USD 11,022 millones para el periodo considerado."

OP:       anio     FOB_tot    FOB_020130    FOB_020220    FOB_020230   prop_020130   prop_020220  prop_020230
-------------------------------------------------------------------------------------------------------------
          2010    251653.2        6617.3      822564.7       1080835      23.28322     0.6122408     76.10454
          2011    300989.0        9543.7      965837.7       1276370      23.58163     0.7477228     75.67064
          2012    346110.5       13205.2      985621.4       1344937      25.73432     0.9818475     73.28383
          2013    348416.1       57778.0      873435.2       1279629      27.22789     4.5152158     68.25689
          2014    394362.1       71380.7      980159.0       1445902      27.27447     4.9367626     67.78877
          2015    348587.8       68429.6      993413.4       1410431      24.71499     4.8516827     70.43333
          2016    367881.0       88220.7      967239.9       1423342      25.84629     6.1981389     67.95557
          2017    366608.9      107617.1     1026755.2       1500981      24.42462     7.1697804     68.40560
-------------------------------------------------------------------------------------------------------------
       (media)                                                            25.26093     3.7516740     70.98740
       
Para el periodo de estudio (2010 a 2017), los promedios de exportaciones de cada una de las partidas varían un poco. Pero se mantiene el orden, siendo la carne deshuesada congelada la que concentra el mayor porcentaje de las exportaciones (70.99%), siguiendo las exportaciones de carne deshuesada enfriada (25.26%) y por último las carnes con hueso (3.75%).


"En términos de mercados de destino de las exportaciones uruguayas, los principales mercados se presentan son: UE (30%), USA (17%), Rusia (16%), Israel (7%), China (6%), Chile (5%), Brasil (4%) y Canadá (4%)"

OP:   Destino     2010       2011       2012      2013      2014      2015       2016      2017      media
----------------------------------------------------------------------------------------------------------
           UE   32.099     31.503     28.246    27.560    28.052    24.032     26.087    24.722  27.787625
        CHINA    2.102      2.135      5.499    20.478    19.146    34.252     35.169    40.302  19.885375
        RUSIA   26.495     25.276     18.693     8.966     6.878     1.401      1.088     1.128  11.240625
     E.E.U.U.    6.779      6.173      9.540    10.035    13.049    17.243     13.656    12.678  11.144125
       ISRAEL    6.285      8.486     11.739    10.315     8.875     8.521      8.200     7.807   8.778500
        CHILE    5.809      5.349      8.227     5.206     2.590     2.417      2.063     2.023   4.210500
       BRASIL    4.526      5.405      2.578     4.870     4.845     3.211      3.427     3.968   4.103750
       CANADA    2.071      2.480      3.862     3.226     7.486     2.707      4.554     2.663   3.631125
    VENEZUELA    4.095      5.733      4.478     3.338     3.533     0.135         NA        NA   3.552000
        SUIZA    1.326      1.585      2.024     2.297     1.680     1.675      1.272     0.961   1.602500
----------------------------------------------------------------------------------------------------------
Para nuestro periodo de análisis hay ciertas variaciones. La principal es el aumento de exportaciones a China, que pasó a ocupar el segundo lugar en 2013 y el primer lugar desde 2015, aumentando más de 30 puntos porcentuales.


"...el índice de Herfindahl inverso, (...). En el caso de Uruguay se observa que de 2010 a 2014 el país diversificó levemente el destino de sus exportaciones (3,6 en 2010 a 5 en 2014)"

OP:       IHH      2010       2011       2012      2013      2014      2015       2016      2017
------------------------------------------------------------------------------------------------
    ihh.carne     0.731      0.737      0.758     0.470     0.575     0.830      0.858     0.720
inv.ihh.carne     1.368      1.357      1.319     2.128     1.739     1.204      1.165     1.388
------------------------------------------------------------------------------------------------
-> Algunas diferencias, para el periodo de estudio el inverso del Índice de Herfindahl vale en promedio 1.368


```{r}
# remove(carne, carne_anio, carne_pais, total_carne_anio, IHH.carne, resumen_carne_ncm6)
```


- Lácteos
```{r}
lacteos <- IHH.producto.aj %>% mutate(capitulo = substring(NCM, 1, 2)) %>% filter(capitulo == "04") %>% 
  group_by(anio, pais, NCM, ncm_4, FOB_tot, FOB_ncm, FOB_pais, cuota2_ncm) %>% summarise(FOB = sum(FOB))

  lacteos_anio <- lacteos %>% group_by(anio, FOB_tot) %>% summarise(FOB_ncm = mean(FOB_ncm), cuota2_ncm = mean(cuota2_ncm)) %>% mutate(prop = FOB_ncm / FOB_tot *100) 
  IHH.lacteos <- lacteos_anio %>% group_by(anio) %>% summarise(ihh.lacteos = cuota2_ncm*100, inv.ihh.lacteos = 1/ihh.lacteos) %>% 
    gather(indice, valor, -anio) %>% mutate(valor = round(valor,3)) %>% spread(anio, valor) %>% as.data.frame
  
lacteos_pais <- base_export_final %>% filter(FOB != 0) %>% filter(capitulo == "04") %>% #mutate(pais = case_when(pais %in% UE ~ "UE", TRUE ~ pais)) %>% 
  group_by(anio, pais, capitulo) %>% summarise(FOB = sum(FOB)) %>% group_by(anio, capitulo) %>% do(mutate(., FOB_capitulo = sum(.$FOB))) %>%
  group_by(anio, pais) %>% mutate(prop = round(FOB/FOB_capitulo *100,3)) %>% group_by() %>% transmute(anio, pais, prop) %>% spread(anio, prop) %>%
  group_by(pais, `2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`) %>% summarise(media = mean(na.omit(c(`2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`)))) %>%
  arrange(-`media`) %>% as.data.frame
head(lacteos_pais, 10)
    


resumen_lacteos_ncm6 <- lacteos %>% mutate(capitulo = substring(NCM, 1, 2), ncm_6 = substring(NCM, 1, 6)) %>% filter(ncm_6 %in% c("040210", "040221", "040510", "040690")) %>% 
  group_by(ncm_6, anio, pais) %>% do(mutate(., FOB = sum(FOB))) %>% group_by(anio, capitulo) %>% do(mutate(., FOB_tot = sum(.$FOB))) %>% mutate(prop = FOB/FOB_tot*100) %>% group_by %>%
  transmute(anio, pais, ncm_6, FOB_tot, FOB, prop) %>% gather(cantidad, valor, -anio, -pais, -ncm_6) %>% mutate(variable = paste(cantidad, ncm_6)) %>% select(-ncm_6, -cantidad) %>% 
  unique %>% spread(variable, valor) %>% rename(FOB_tot =  `FOB_tot 040210`) %>% select(-`FOB_tot 040221`, -`FOB_tot 040510`, -`FOB_tot 040690`) %>% 
  mutate(prop4sub = haz.cero.na(`prop 040210`)+haz.cero.na(`prop 040221`)+haz.cero.na(`prop 040510`)+haz.cero.na(`prop 040690`))


 resumen_pais_4sub <- resumen_lacteos_ncm6 %>% group_by(anio) %>% summarise(sum(prop4sub))
 resumen_anio_4sub <- resumen_lacteos_ncm6 %>% select(-pais, -prop4sub) %>% gather(key, value, -anio) %>% filter(is.na(value) != TRUE) %>%
   group_by(anio, key) %>% summarise(value = sum(value)) %>% spread(key, value) %>% mutate(prop4sub = `prop 040210`+`prop 040221`+`prop 040510`+`prop 040690`) %>%
   group_by(anio) %>% summarise(sum(prop4sub))

```

"El 86% de las exportaciones de lácteos1 de Uruguay se concentran en cuatro subpartidas arancelarias: Leche en PolvoDescremada-LPD (040210), Leche en Polvo Entera – LPE (040221), Manteca (040510) y Queso (040690)."


OP:       anio      040210     040221      040510      040690    FOB_tot  prop_040210  prop_040221  prop_040510  prop_040690   prop4sub
---------------------------------------------------------------------------------------------------------------------------------------
          2010    32750.62   204162.0    35785.30   172625.55   14844193     4.191954     26.13196     4.580382     22.09541   56.99971
          2011    92834.74   218408.0    68137.37   202891.66   12566944     9.603382     22.59344     7.048538     20.98833   60.23368
          2012   104675.35   216667.7    95013.72   233990.70   24156071     9.533246     19.73289     8.653319     21.31057   59.23002
          2013   125343.76   339452.9   101739.33   225089.35   24831278    10.095635     27.34075     8.194449     18.12950   63.76034
          2014    93868.41   285670.5    98827.94   214324.64   14025378     7.362030     22.40492     7.751002     16.80932   54.32728
          2015    70142.09   286123.5    59168.31   115515.84    9133711     9.215367     37.59131     7.773617     15.17663   69.75693
          2016    46911.00   317783.3    38532.17    80575.91    5174040     7.253287     49.13503     5.957770     12.45849   74.80458
          2017    35047.73   341109.3    49222.58    71064.70    5128814     5.466797     53.20674     7.677811     11.08478   77.43613
---------------------------------------------------------------------------------------------------------------------------------------
Para nuestro periodo, las primeras 4 subpartidas representan en promedio el 64.57% de las exportaciones de lácteos.


"Considerando los datos de estos productos en valores, el principal mercado de destino en el período 2005-2014 fue Venezuela, seguido de Brasil, México y Rusia. Hay mucha variabilidad en el período, pero Venezuela y Rusia son los dos destinos que más incrementan su participación, seguido de Argelia. Brasil, con fuertes fluctuaciones, también muestra una participación creciente."


OP:   Destino     2010       2011       2012      2013      2014      2015       2016      2017      media
----------------------------------------------------------------------------------------------------------
       BRASIL   19.761     27.208     28.854    22.396    14.734    26.489     59.424    36.854  29.465000
    VENEZUELA   30.032     26.824     31.766    34.292    34.071    20.677      0.066     0.088  22.227000
        RUSIA    3.108      3.252      7.236     9.954    14.479     7.722      8.595    10.782   8.141000
      ARGELIA    5.781      4.236      2.279     5.348     5.937    11.383      6.956    19.551   7.683875
       MEXICO   11.498     10.060      5.749     3.161     4.014     9.645      5.840     5.204   6.896375
         CUBA    6.343      7.251      4.026     1.883     3.111     1.616      2.583     4.774   3.948375
        CHINA    1.779      1.366      1.297     9.120     6.888     2.509      2.725     1.587   3.408875
     E.E.U.U.    1.965      3.862      4.047     3.579     2.935     4.531      1.619     2.788   3.165750
    ARGENTINA    2.392      1.728      1.785     1.841     1.355     0.663      1.351     2.965   1.760000
     ALEMANIA    2.575      1.438      0.074     0.890     1.465     1.458      0.970     0.792   1.207750
----------------------------------------------------------------------------------------------------------
Para el periodo de estudio, el principal cambio es la caída de las exportaciones a Venezuela, dejando de ser un destino para las exportaciones de productos lácteos. Brasil, tuvo un importante crecimiento en el 2016 aumentando 124% los montos. Rusia, México y Argelia, siguen estando dentro de los principales destinos, se destaca el incremento de las exportaciones a Argelia el último año (aumentaron 181%).


OP:         IHH      2010      2011     2012     2013     2014      2015       2016      2017
----------------------------------------------------------------------------------------------
    ihh.lacteos     0.046     0.045    0.048    0.067    0.045     0.042      0.049     0.042
inv.ihh.lacteos    21.719    22.309   20.631   14.830   22.286    24.028     20.403    24.023
----------------------------------------------------------------------------------------------


```{r}
# remove(lacteos, lacteos_anio, lacteos_pais, IHH.lacteos, resumen_lacteos_ncm6, resumen_pais_4sub, resumen_anio_4sub)

```



# Actualización 18/04/2018
El coeficiente exportador debe calcularse como la propoción de las exportaciones de bienes en el PIB de la economía.
Se lee nuevamente la base de PIB y se calcula nuevamente el CE
```{r}
file <- "../../bases_publicas/bcu/data/externas/cuadro_100t.xls"


datos <- function(file){
  read_xls(file, range = "A10:BB22") %>%                                                           # levanta datos
  rename(codigo_industria=X__1,desc_industria=X__2) %>%
  filter(desc_industria == "PRODUCTO INTERNO BRUTO") %>%
  melt() %>%                                                                                       # preparacion de bd incluido tratamiento de trimestre
  rename(trim_orig=variable, valor=value) %>%                                                      # mantiene dato de trimestre con formato original
  mutate(desc_industria = stri_trans_totitle(desc_industria),                                      # mayusculas y minusculas a titulo
         archivo = file, trim = trim_orig) %>%                                                     # replica trimestre original para luego modificar
  separate(trim, c("fecha", "anio"), " ") %>%                                                      # separa romano y anio
  mutate(fecha = case_when(fecha=="I" ~ "01-01", fecha=="II" ~ "01-04", 
                           fecha=="III" ~ "01-07", fecha=="IV" ~ "01-10"),
         anio = substring(anio,1,4),                                                               # limpia asterisco en anio (pero queda como character)
         fecha = dmy(paste(fecha, anio, sep="-")),                                                 # lubridate: fecha con formato d-m-y
         trimestre = quarter(fecha))                                                               # lubridate: crea trimestre con formato q.y
}

PIB_global <- file %>% datos %>%
  mutate(anio = year(fecha))                             # corrige clase

```


-> PIB anual en miles de dólares:
```{r}
PIB_anual_usd_mm <- PIB_global %>% group_by(anio) %>% summarise(pib = sum(valor)) %>% spread(anio, pib) %>% as.data.frame

for (i in names(PIB_anual_usd_mm)) {
  PIB_anual_usd_mm[i] <- PIB_anual_usd_mm[i] / TC_anual[i]  
}

```


Fuentes: transaction (export.) y BCU (PIB)
```{r}
CE <- NULL
for (i in names(export.por.anio.final)) {
  CE[i] <- export.por.anio.final[i] / PIB_anual_usd_mm[i] * 100
}
CE <- CE %>% as.data.frame
names(CE) <- names(export.por.anio.final)

CE_table <- left_join(
  export.por.anio.final %>% gather(anio, FOB) %>% transmute(anio, usd_mm = FOB/1000),
  PIB_anual_usd_mm %>% gather(anio, va_usd_mm) %>% mutate(va_usd_mm = va_usd_mm/1000) %>% filter(anio %in% c(2010:2017))) %>%
  mutate(ce = usd_mm/va_usd_mm*100)

#saveRDS(CE_table, "../data/internas/shiny/coef_export_anio_global.rds")

```
-> Estos valores corresponden a la economía en su conjunto




# Generación data frame auxiliares
Se arma un data frame para reconocer las empresas exportadoras de granos.

```{r}

empresas.zf.np <- exportaciones %>% filter(pais == "Z.FRANCA N.PALMIRA") %>% select(EXPORTADOR) %>% unique             # 73 empresas
export.empresas.zf.np <- exportaciones %>% filter(EXPORTADOR %in% empresas.zf.np$EXPORTADOR)
# saveRDS(export.empresas.zf.np, "../data/internas/export.empresas.zf.np.rds")
```

Se agrupa por variables de interés para depurar el data frame
```{r}
base_export_final_group <- base_export_final_eni %>% group_by(anio, pais, ncm_4, EI) %>% summarise(FOB = sum(FOB))
# saveRDS(base_export_final_group, "../data/internas/shiny/base_export_final_group.rds")
```

